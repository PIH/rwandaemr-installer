<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd">

    <changeSet id="rwandaemr-imb-create-dose-units-set" author="IMB">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                select count(*) from concept where uuid = '162384AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA'
            </sqlCheck>
        </preConditions>
        <sql>
            set @doseUnitsConceptUuid = '162384AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA';
            call ensure_concept(@doseUnitsConceptUuid, 'N/A', 'ConvSet', 1);
            call ensure_concept_name('47664f7e-d5cb-11ea-b2b0-0242ac110002', @doseUnitsConceptUuid, 'Dosing unit', 'FULLY_SPECIFIED');
            update global_property set property_value = @doseUnitsConceptUuid where property = 'order.drugDosingUnitsConceptUuid';
        </sql>
    </changeSet>

    <changeSet id="rwandaemr-imb--migrate-dose-units" author="IMB">
        <sql>
            call migrate_dose_units('2590eec3-d9d3-4e30-813b-8b77da65184f', 'AUC'); # This is area under curve
            call migrate_dose_units('75312e5f-b9b8-48cd-a4a7-73a2ba14b000', 'CAPSULE');
            call migrate_dose_units('75312e5f-b9b8-48cd-a4a7-73a2ba14b000', 'capsule');
            call migrate_dose_units('161554AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA', 'g');
            call migrate_dose_units('215a019e-6f1e-4c4d-b6ab-b0d080f89dc4', 'INTRAVENOUS'); # Uses mL
            call migrate_dose_units('162264AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA', 'IU IM'); # Uses international units
            call migrate_dose_units('162262AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA', 'L');
            call migrate_dose_units('162366AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA', 'mcg');
            call migrate_dose_units('8abb49a6-20ae-4593-9334-fc5db6947621', 'mg');
            call migrate_dose_units('41f9cc75-d154-4cb2-bcd3-1ffcebda33c0', 'mg/k');
            call migrate_dose_units('41f9cc75-d154-4cb2-bcd3-1ffcebda33c0', 'mg/kg');
            call migrate_dose_units('05d778f0-6282-4eed-9c58-6b5d0703c5a7', 'mg/ml');
            call migrate_dose_units('0c07db8a-5be7-4b63-be70-191a7e3466b1', 'mg/m2');
            call migrate_dose_units('529ab651-e77e-4708-b411-ee5a39c35d4e', 'mg/1.25ml');
            call migrate_dose_units('d43054ef-39d9-4af5-96c2-cf088a1af7be', 'mg/5ml');
            call migrate_dose_units('215a019e-6f1e-4c4d-b6ab-b0d080f89dc4', 'ml');
            call migrate_dose_units('937a8e79-0d95-4b3a-9567-6a76ebeba9a5', 'ml/kg');
            call migrate_dose_units('7f281469-73f4-4e0f-a197-45e9ddbb4b7e', 'ml/m2');
            call migrate_dose_units('7f281469-73f4-4e0f-a197-45e9ddbb4b7e', 'mL/m2');
            call migrate_dose_units('6735094c-8416-43e3-8a3c-091332a08cb7', 'OR'); # Uses Dosing unspecified
            call migrate_dose_units('6735094c-8416-43e3-8a3c-091332a08cb7', 'ORAL'); # Uses Dosing unspecified
            call migrate_dose_units('6735094c-8416-43e3-8a3c-091332a08cb7', 'SUSPENDED'); # Uses Dosing unspecified
            call migrate_dose_units('3f2b8c24-aef1-41ef-a409-d089b3d1a839', 'TABLET');
            call migrate_dose_units('3f2b8c24-aef1-41ef-a409-d089b3d1a839', 'tablet');
            call migrate_dose_units('3f2b8c24-aef1-41ef-a409-d089b3d1a839', 'tab(s)');
            call migrate_dose_units('162264AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA', 'UI'); # Uses international units
            call migrate_dose_units('07b05a2a-87ff-44ce-bb5c-5d6855bf8b11', 'unit');
            call migrate_dose_units('07b05a2a-87ff-44ce-bb5c-5d6855bf8b11', 'units');
            call migrate_dose_units('3a11abee-25b1-45af-8dc8-0eea2bd5b77c', 'units/kg');
            call migrate_dose_units('b0da4127-ac49-4ab4-8e9c-99c748be53b4', 'units/m2');
            call migrate_dose_units('3f2b8c24-aef1-41ef-a409-d089b3d1a839', '200 mg'); # Uses tablet
            call migrate_dose_units('6735094c-8416-43e3-8a3c-091332a08cb7', null);
            call migrate_dose_units('6735094c-8416-43e3-8a3c-091332a08cb7', '');

            select concept_id into @unitSetId from concept where uuid = '162384AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA';

            delete from concept_set where concept_set = @unitSetId and @unitSetId is not null;

            insert into concept_set (concept_id, concept_set, sort_weight, creator, date_created, uuid)
                select  distinct dose_units, @unitSetId, 1, 1, now(), uuid()
                from    drug_order
                where   dose_units is not null;
        </sql>
    </changeSet>

</databaseChangeLog>
